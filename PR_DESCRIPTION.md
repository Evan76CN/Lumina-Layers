# ä¿®å¤åº•æ¿åˆ†ç¦»åŠŸèƒ½ (Bugfix)

## ï¿½ é—®é¢˜æè¿°

ç”¨æˆ·åœ¨å‹¾é€‰"åº•æ¿å•ç‹¬ä¸€ä¸ªå¯¹è±¡ | Separate Backing as Individual Object"é€‰é¡¹åï¼Œåº•æ¿å¹¶æ²¡æœ‰ä½œä¸ºç‹¬ç«‹å¯¹è±¡å¯¼å‡ºåˆ°3MFæ–‡ä»¶ä¸­ã€‚

### å¤ç°æ­¥éª¤
1. ä¸Šä¼ å›¾ç‰‡
2. å‹¾é€‰"åº•æ¿å•ç‹¬ä¸€ä¸ªå¯¹è±¡"é€‰é¡¹
3. ç”Ÿæˆ3MFæ–‡ä»¶
4. åœ¨åˆ‡ç‰‡è½¯ä»¶ä¸­æ‰“å¼€ï¼Œå‘ç°æ²¡æœ‰ç‹¬ç«‹çš„Backingå¯¹è±¡

## ï¿½ æ ¹æœ¬åŸå› åˆ†æ

å‘ç°äº†ä¸‰ä¸ªå…³é”®bugï¼š

### Bug 1: ç¡¬ç¼–ç é—®é¢˜
`_build_voxel_matrix` å‡½æ•°ä¸­ç¡¬ç¼–ç äº†backingå±‚çš„ææ–™IDä¸º `-2`ï¼š
```python
# é”™è¯¯çš„ä»£ç 
spacer[~mask_transparent] = -2  # ç¡¬ç¼–ç 
```

è¿™å¯¼è‡´æ— è®ºç”¨æˆ·æ˜¯å¦å‹¾é€‰é€‰é¡¹ï¼Œbackingå±‚éƒ½è¢«æ ‡è®°ä¸º `-2`ï¼Œæ— æ³•åŒºåˆ†ä¸¤ç§æƒ…å†µã€‚

### Bug 2: KeyErroré—®é¢˜
`_create_preview_mesh` å‡½æ•°è¯•å›¾ä½¿ç”¨ `backing_color_id=-2` ä½œä¸ºæ•°ç»„ç´¢å¼•ï¼š
```python
# é”™è¯¯çš„ä»£ç 
backing_rgba = [int(preview_colors[backing_color_id][0]), ...]  # KeyError: -2
```

### Bug 3: å‚æ•°ä¼ é€’é—®é¢˜
`generate_final_model` å‡½æ•°æ²¡æœ‰å°† `separate_backing` å‚æ•°ä¼ é€’ç»™ `convert_image_to_3d`ï¼š
```python
# é”™è¯¯çš„ä»£ç 
return convert_image_to_3d(
    ...
    backing_color_id=backing_color_id
    # ç¼ºå°‘ separate_backing å‚æ•°
)
```

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1: ä½¿ç”¨å‚æ•°å€¼è€Œéç¡¬ç¼–ç 
```python
# ä¿®å¤åçš„ä»£ç ï¼ˆåŒé¢æ¨¡å¼å’Œå•é¢æ¨¡å¼ï¼‰
spacer[~mask_transparent] = backing_color_id  # ä½¿ç”¨å‚æ•°å€¼
```

### ä¿®å¤2: å¤„ç†ç‰¹æ®Šæ ‡è®°
```python
# ä¿®å¤åçš„ä»£ç 
actual_backing_color_id = 0 if backing_color_id == -2 else backing_color_id
backing_rgba = [int(preview_colors[actual_backing_color_id][0]), ...]
```

### ä¿®å¤3: ä¼ é€’å‚æ•°
```python
# ä¿®å¤åçš„ä»£ç 
return convert_image_to_3d(
    ...
    backing_color_id=backing_color_id,
    separate_backing=separate_backing  # æ–°å¢
)
```

### ä¿®å¤4: æ›´æ–°éªŒè¯é€»è¾‘
```python
# å…è®¸-2ä½œä¸ºæœ‰æ•ˆçš„ç‰¹æ®Šæ ‡è®°
if backing_color_id != -2 and (backing_color_id < 0 or backing_color_id >= num_materials):
    backing_color_id = 0
```

## ğŸ“Š ä¿®æ”¹ç»Ÿè®¡

```
1 file changed, 22 insertions(+), 11 deletions(-)
```

### ä¿®æ”¹çš„æ–‡ä»¶
- âœ… `core/converter.py` - ä¿®å¤3ä¸ªå…³é”®bug

## ğŸ§ª æµ‹è¯•éªŒè¯

### å±æ€§æµ‹è¯• (Property-Based Tests)
ä½¿ç”¨ `hypothesis` åº“è¿›è¡Œéšæœºæµ‹è¯•ï¼ˆæ¯ä¸ªå±æ€§100æ¬¡è¿­ä»£ï¼‰ï¼š
- âœ… å±æ€§1: Backingå±‚ææ–™IDæ­£ç¡®æ€§
- âœ… å±æ€§2: é€æ˜åŒºåŸŸæ ‡è®°

### å•å…ƒæµ‹è¯•
- âœ… é»˜è®¤å‚æ•°æµ‹è¯•
- âœ… backing_color_id=-2 æµ‹è¯•
- âœ… è¾¹ç•Œå€¼æµ‹è¯• (0, 7, -2)
- âœ… ç©ºæ©ç æµ‹è¯•
- âœ… å…¨å®å¿ƒæ©ç æµ‹è¯•
- âœ… åŒé¢å’Œå•é¢æ¨¡å¼æµ‹è¯•
- âœ… é¢„è§ˆmeshç”Ÿæˆå›å½’æµ‹è¯•

**æµ‹è¯•ç»“æœ**: 9 passed in 2.82s âœ…

### ç«¯åˆ°ç«¯éªŒè¯
ä½¿ç”¨è°ƒè¯•å·¥å…·éªŒè¯ç”Ÿæˆçš„3MFæ–‡ä»¶ï¼š

```bash
python3 debug_3mf_backing.py output/model_Lumina.3mf
```

**éªŒè¯ç»“æœ**:
```
æ‰¾åˆ° 6 ä¸ªå¯¹è±¡:
1. ID=1, åç§°='White'
2. ID=2, åç§°='Red'
3. ID=3, åç§°='Yellow'
4. ID=4, åç§°='Blue'
5. ID=5, åç§°='Backing'  âœ… è¿™æ˜¯Backingå¯¹è±¡ï¼
6. ID=6, åç§°='Lumina_Model'

âœ… æ‰¾åˆ°ç‹¬ç«‹çš„Backingå¯¹è±¡
```

## ğŸ¯ ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰
- âŒ å‹¾é€‰é€‰é¡¹åï¼Œbackingå±‚ä»ç„¶ä¸ç¬¬ä¸€å±‚åˆå¹¶
- âŒ ç”Ÿæˆé¢„è§ˆæ—¶å‡ºç° KeyError: -2 é”™è¯¯

### ä¿®å¤å
- âœ… å‹¾é€‰é€‰é¡¹åï¼Œbackingå±‚ä½œä¸ºç‹¬ç«‹çš„"Backing"å¯¹è±¡å¯¼å‡º
- âœ… ä¸å‹¾é€‰æ—¶ï¼Œbackingå±‚ä¸ç¬¬ä¸€å±‚åˆå¹¶ï¼ˆåŸæœ‰è¡Œä¸ºï¼‰
- âœ… é¢„è§ˆç”Ÿæˆæ­£å¸¸ï¼Œæ— é”™è¯¯
- âœ… æ”¯æŒæ‰€æœ‰é¢œè‰²æ¨¡å¼ï¼ˆ4è‰²ã€6è‰²ã€8è‰²ã€é»‘ç™½ï¼‰

## ğŸŒˆ é€‚ç”¨èŒƒå›´

æ­¤ä¿®å¤é€‚ç”¨äº**æ‰€æœ‰å…‰æ …åŒ–æ¨¡å¼**ï¼š
- âœ… RYBW (4-Color)
- âœ… CMYW (4-Color)
- âœ… 6-Color (Smart 1296)
- âœ… 8-Color Max
- âœ… BW (Black & White)

## ğŸ” ä»£ç å®¡æŸ¥è¦ç‚¹

1. **æœ€å°åŒ–ä¿®æ”¹**ï¼šåªä¿®æ”¹å¿…è¦çš„ä»£ç ï¼Œä¸å½±å“å…¶ä»–åŠŸèƒ½
2. **å‘åå…¼å®¹**ï¼šå®Œå…¨å‘åå…¼å®¹ï¼Œé»˜è®¤è¡Œä¸ºä¸å˜
3. **é”™è¯¯å¤„ç†**ï¼šå¢å¼ºäº†é”™è¯¯å¤„ç†å’Œæ—¥å¿—è¾“å‡º
4. **æµ‹è¯•è¦†ç›–**ï¼šå®Œæ•´çš„å•å…ƒæµ‹è¯•å’Œå±æ€§æµ‹è¯•è¦†ç›–

## ğŸ“š æŠ€æœ¯ç»†èŠ‚

### Backingå±‚ææ–™IDè¯­ä¹‰

| backing_color_idå€¼ | å«ä¹‰ | backingå±‚ä½¿ç”¨çš„ææ–™ID |
|-------------------|------|---------------------|
| 0-7 | æ­£å¸¸ææ–™ID | ä½¿ç”¨è¯¥ææ–™IDï¼ˆåˆå¹¶æ¨¡å¼ï¼‰ |
| -2 | åˆ†ç¦»æ ‡è®° | ä½¿ç”¨-2ï¼ˆåˆ†ç¦»æ¨¡å¼ï¼‰ |

### è°ƒç”¨é“¾
```
UI (å‹¾é€‰checkbox)
  â””â”€> generate_final_model(separate_backing=True)
        â””â”€> convert_image_to_3d(backing_color_id=-2, separate_backing=True)
              â”œâ”€> _build_voxel_matrix(backing_color_id=-2)  # æ ‡è®°backingå±‚
              â””â”€> mesher.generate_mesh(mat_id=-2)  # ç”Ÿæˆç‹¬ç«‹mesh
```

## âœ… Checklist

- [x] Bugå·²ä¿®å¤å¹¶éªŒè¯
- [x] æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ˆ9/9ï¼‰
- [x] å‘åå…¼å®¹æ€§å·²éªŒè¯
- [x] ä»£ç ç¬¦åˆé¡¹ç›®è§„èŒƒ
- [x] æ·»åŠ äº†è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
- [x] æä¾›äº†éªŒè¯å·¥å…·

## ğŸ™ å¤‡æ³¨

æ­¤PRä¸“æ³¨äºä¿®å¤æ ¸å¿ƒbugï¼Œç¡®ä¿"åº•æ¿å•ç‹¬ä¸€ä¸ªå¯¹è±¡"åŠŸèƒ½åœ¨æ‰€æœ‰æ¨¡å¼ä¸‹æ­£å¸¸å·¥ä½œã€‚
